# 10. 데이터베이스 테스트

## 데이터베이스 테스트를 위한 전제 조건

- 형상 관리 시스템에 데이터베이스 유지
    - 데이터베이스 스키마도 Git과 같이 저장하는 것이 좋다.
    - 변경 내역으로 버그를 재현할 수 있고, 원천 정보를 단일화 할 수 잇음
    - 그대신 다른 걸로 조작하면 안된다.
    - 참조데이터
        - 애플리케이션이 제대로 작동하도록 미리 채워야하는 데이터이다.
        - 이것도 SQL INSERT문으로 형상관리 되어야 한다.
- 모든 개발자를 위한 별도의 데이터베이스 인스턴스 사용
    - 공유 데이터베이스를 사용하게 되면 개발 프로세스를 방해할 수 있다.
        - 서로 다른 개발자가 실행한 테스트는 서로 간섭된다.
        - 하위 호환성이 없는 변경으로 다른 개발자의 작업을 막을 수 있다.
    - 별도로 데이터 베이스 인스턴스를 사용해라.
- 데이터베이스 배포에 마이그레이션 기반 방식 적용
    - 상태기반 방식 배포
        - 유지 보수하는 모델 데이터베이스를 기준으로 운영 데이터베이스와 비교해 항상 최신화를 한다.
    - 마이그레이션 기반 방식 배포
        - 버전 기준으로 전환하는 명시적인 마이그레이션 의미함
    - 상태 기반 방식보다 마이그레이션 기반 방식을 선호하라
        - 데이터베이스 상태가 명확하면 병합 충돌을 처리하기가 수월함
        - 마이그레이션이 명확하면 데이터 모션 문제 해결이 쉬움
            - 데이터 모션: 새로운 데이터베이스 스키마를 준수하도록 기존 데이터의 형태를 변경하는 과정
        - 병합충돌과 데이터 모션은 둘다 중요한 것처럼 보이지만 데이터 모션이 훨씬 더 중요하다.

## 데이터베이스 테스트 모범 사례

- 트랜잭션

## 테스트 데이터 생명 주기

- 공유 데이터 베이스를 사용하면 통합 테스트를 서로 분리할 수 없는 문제가 생긴다.
    - 다음으로 해결 가능
        - 통합 테스트를 순차적으로 실행하기
        - 테스트 실행 간에 남은 데이터 클렌징하기
- 통합 테스트를 순차적으로 실행하기
    - 병렬적으로 실행할 수 있지만, 그러면 너무 비용이 많이 들음
        - 그냥 병렬적으로 실행하려면 항상 데이터를 고려해서 테스트를 짜야해서 머리아픔
        - DB인스턴스를 새로 띄워서 하려면 하드웨어 리소스와 유지보수 리소스가 너무 많이 들어감
    - 그냥 테스트 하고 데이터 정리하자
        - 각 테스트 전에 데이터베이스 백업 복원하기
        - 테스트 종료 시점에 데이터 정리하기
        - 데이터베이스 트랜잭션에 각 테스트를 래핑하고 커밋하지 않기
        - **테스트 시작 시점에 데이터 정리하기**: 이게 베스트, 빠르고 실수할 여지가 가장 적음
- 인메모리 DB 사용하지 마라
    - 장점은 많은데 하여간 운영 DB랑 설정이 다를 수 있으므로 거짓 양성이 뜰 수 있다.
- 테스트 구절에서 코드 재사용 해라
    - 코드는 짧으면 좋다.
    - 비즈니스와 관련이 없는 기술적인 부분을 비공개 메서드나 헬퍼 클래스로 추출해라. 그리고 재사용 해라

## 테스트 내 데이터베이스 트랜잭션 관리

- 타협점이 그렇게 많지는 않다.
- 트랜잭션이 많아지면 테스트가 느려지긴 하지만 빠른 피드백과 유지보수성 간의 절충을 해야한다.
- 유지보수성이 우선되어야 하지만 성능저하가 그렇게 크지 않으면 괜찮다.